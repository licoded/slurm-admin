# Project Structure

```
slurm-admin/
├── .gitignore              # Git ignore patterns
├── .env.example            # Environment configuration template
├── pyproject.toml          # Project configuration (uv)
├── requirements.txt        # Python dependencies
├── uv.lock                 # Dependency lock file (auto-generated)
├── README.md               # Main documentation
├── QUICKSTART.md           # Quick start guide
├── slm.py                  # Core SDK CLI tool
├── test_slm.sh             # Local test script
│
├── .venv/                  # Virtual environment (auto-generated by uv)
│
├── examples/               # Example Slurm job scripts
│   ├── simple_job.sh               # Simple test job
│   ├── unzip_benchmarks_slurm.sh  # File extraction job
│   └── train_model.sh              # ML training job
│
├── logs/                   # Slurm job output logs
│   └── .gitkeep
│
└── output/                 # Job output data
    └── .gitkeep
```

## File Descriptions

### Core Files

| File | Description |
|------|-------------|
| `slm.py` | Main CLI tool implementing SLM SDK with two commands: `submit` and `run` |
| `pyproject.toml` | Project metadata and dependencies configuration for uv |
| `requirements.txt` | Alternative dependency specification for pip users |
| `.env.example` | Template for environment configuration (webhook URL, etc.) |

### Documentation

| File | Purpose |
|------|---------|
| `README.md` | Comprehensive documentation with architecture, usage, and examples |
| `QUICKSTART.md` | 5-minute setup guide with common patterns |
| `PROJECT_STRUCTURE.md` | This file - project structure overview |

### Examples

| File | Use Case |
|------|----------|
| `examples/simple_job.sh` | Quick test job to verify SLM is working |
| `examples/unzip_benchmarks_slurm.sh` | File extraction with error handling |
| `examples/train_model.sh` | ML training job with GPU resources |

### Testing

| File | Purpose |
|------|---------|
| `test_slm.sh` | Local test suite (runs without Slurm) to verify setup |

## Key Features

### 1. Two-Layer Architecture
- **Submission Layer** (`slm submit`): Captures job submission events
- **Execution Layer** (`slm run`): Monitors job execution lifecycle

### 2. Signal Handling
Captures all Slurm-related signals:
- `SIGTSTP` → PAUSED (scontrol suspend)
- `SIGCONT` → RESUMED (scontrol resume)
- `SIGTERM` → TERMINATING (scancel/timeout)
- `SIGINT` → TERMINATING (Ctrl+C)

### 3. Event Notifications
Sends webhooks for all lifecycle events:
- SUBMITTED, RUNNING, PAUSED, RESUMED, TERMINATING, COMPLETED, FAILED

### 4. Zero Pollution
Original shell scripts remain unchanged - just wrap with `slm run`

## Integration Patterns

### Pattern 1: Direct Command
```bash
uv run slm.py run -- python my_script.py
```

### Pattern 2: Inline Bash
```bash
uv run slm.py run -- bash <<'EOF'
# Your complex logic here
EOF
```

### Pattern 3: Job Script
```bash
#!/bin/bash
#SBATCH -J myjob
#SBATCH -c 4

uv run slm.py run -- python main.py
```

## Configuration

### Environment Variables
```bash
export SLM_WEBHOOK="https://your-webhook-url.com"
```

### Command-Line Arguments
```bash
uv run slm.py --webhook "https://..." run -- command
```

## Dependencies

- Python >= 3.8
- requests >= 2.31.0
- uv (for package management)

## Installation

### Using uv (Recommended)
```bash
uv sync
```

### Using pip
```bash
pip install -r requirements.txt
```

## Usage Examples

### Submit a job
```bash
# Without SUBMITTED notification
sbatch examples/simple_job.sh

# With SUBMITTED notification
uv run slm.py submit examples/simple_job.sh
```

### Run with monitoring
```bash
# Simple command
uv run slm.py run -- python script.py

# With arguments
uv run slm.py run -- python train.py --epochs 100 --batch-size 32

# Bash script
uv run slm.py run -- bash my_script.sh

# Inline bash
uv run slm.py run -- bash <<'EOF'
set -e
python step1.py
python step2.py
EOF
```

## Testing

### Local testing (without Slurm)
```bash
./test_slm.sh
```

### Slurm job testing
```bash
# Submit test job
sbatch examples/simple_job.sh

# Monitor status
squeue -u $USER

# View logs
tail -f logs/simple_*.out

# Test signals
scontrol suspend <job_id>  # PAUSED
scontrol resume <job_id>   # RESUMED
scancel <job_id>           # TERMINATING
```

## Extensibility

### Custom Webhook Format
Edit `SlmSDK.send_webhook()` in `slm.py` to customize payload for your webhook provider.

### Additional Signals
Add more signal handlers in `monitor_run()` method.

### Custom Events
Extend event types and emoji mappings in `send_webhook()` method.

## Best Practices

1. **Always use `set -e`** in bash scripts to exit on errors
2. **Wrap complex logic** with inline bash (`<<'EOF'`) to avoid escaping issues
3. **Configure webhook** once in `.bashrc` to avoid repeating
4. **Test locally** first with `test_slm.sh` before submitting to Slurm
5. **Use absolute paths** or set proper `PATH` in job scripts
6. **Check logs** in `logs/` directory for job output
7. **Monitor jobs** with `squeue` and check webhook notifications

## Troubleshooting

### Webhook not sending
- Check `SLM_WEBHOOK` environment variable
- Verify `requests` module is installed
- Test webhook URL with curl

### Signal handling not working
- Ensure using `slm run` wrapper
- Check job is in RUNNING state (not PENDING)
- Verify signal sent to correct job ID

### Command not found
- Use absolute path to `slm.py`
- Or add project directory to PATH
- Or use `uv run slm.py` from project root
